window.DL=window.DL||{};(function(_,$,DL,localized,ajaxUrl){"use strict";var Task={success:function(data){var response;try{response=data.data;this.offset+=this.number;if("failed"in response.data){_.union(this.failed,response.data.failed)}this.completed=response.data.completed}catch(e){this.completed=true;response=e}if(this.completed){DL.Utils.Events.dispatchEvent(this.name+"_completed",window,null,{response:response});return}this.exec()},error:function(jqXHR){var response={};this.completed=true;try{if(!_.isUndefined(jqXHR.responseJSON)){response=jqXHR.responseJSON.data;if("failed"in response.data){_.union(this.failed,response.data.failed)}}}catch(e){response=e}DL.Utils.Events.dispatchEvent(this.name+"_error",window,null,{response:response})},exec:function(){$.ajax(ajaxUrl,{cache:false,contentType:"application/x-www-form-urlencoded; charset="+localized.charset,context:this.form,data:this.args(),dataType:"json",global:false,method:"POST",timeout:3e5,success:this.success,error:this.error})},args:function(){return{dlajax_action:"request_task",request_task_nonce:this.nonce,task_name:this.name,task_args:{number:parseInt(this.number),offset:parseInt(this.offset)}}},init:function(){},construct:function(nonce){_.bindAll(this,"init","exec","args","success","error");this.name="refactor_listings_meta_location";this.nonce=nonce;this.number=10;this.offset=0;this.completed=false;this.failed=[];return this}};var TaskForm={toggleLoader:function(){DL.Utils.UI.toggleLoader(this.form)},message:function(failed,message){message&&this.form.insertAdjacentHTML("beforeBegin","<h3>"+message+"</h3>");if(!_.isUndefined(failed)&&!_.isEmpty(failed)){var list=document.createElement("ul");_.forEach(failed,function(item){var el=document.createElement("li");el.innerHTML='<a href="'+item.permalink+'">'+item.title+"</a>";list.appendChild(el)});this.form.appendChild(list)}this.form.querySelector("#run_task").remove();this.toggleLoader()},exec:function(evt){evt.preventDefault();evt.stopPropagation();this.toggleLoader();this.task.exec()},init:function(){DL.Utils.Events.addListener(this.form,"submit",this.exec);DL.Utils.Events.addListener(window,["refactor_listings_meta_location_completed","refactor_listings_meta_location_error"],function(evt){var failed,message;try{failed=evt.detail.response.data.failed;message=evt.detail.response.message}catch(e){failed=[];message="Unknown error."}this.message(failed,message)}.bind(this))},construct:function(form,task){_.bindAll(this,"init","exec","toggleLoader");this.task=task;this.form=form;return this}};var TaskFactory=function(nonce,options){return Object.create(Task).construct(nonce,options)};var TaskFormFactory=function(form){return Object.create(TaskForm).construct(form,TaskFactory(form.querySelector("#request_task_nonce").value))};window.addEventListener("load",function(){var form=document.querySelector("#task_refactor_listings_meta_location");if(!form){return}var task=TaskFormFactory(form);task&&task.init()})})(window._,window.jQuery,window.DL,window.dllocalized,window.ajaxurl);