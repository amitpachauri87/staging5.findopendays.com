window.DL=window.DL||{};(function(dllocalized,$,DL){"use strict";window.addEventListener("load",function(){var form=document.querySelector("#qibla_listing_form");if(form){var dlform=DL.Form.getForm(form,{ajaxAction:form.querySelector("#qibla_listing_form_action").value,forceMediaUpdate:false,onInit:function(){if(!_.isUndefined(this.dropZone)){_.forEach(this.dropZone.dropzoneCollection,function(dropzone){dropzone.on("removedfile",function(element){var dzPrefilledDataRef=dropzone.options.dzPrefilledDataRef;if(!_.isUndefined(dzPrefilledDataRef)){var el=this.form.querySelector("#"+dzPrefilledDataRef),values=el.value.split(",").map(function(val){return parseInt(val)});var existsIndex=values.indexOf(element.id);if(-1!==existsIndex){values.splice(existsIndex,1);el.value=values.join(",");this.forceMediaUpdate=true}}}.bind(this))}.bind(this))}},ajaxSuccessCb:function(success){var response=success.data,_self=this,count=this.dropZone.dropzoneCollection.length,performDropzoneUpload=false;for(var c=0;c<count;++c){if(this.dropZone.dropzoneCollection[c].getQueuedFiles().length){performDropzoneUpload=true;break}}if(performDropzoneUpload||this.forceMediaUpdate){if(this.forceMediaUpdate&&!performDropzoneUpload){$.ajax(dllocalized.site_url+"/index.php",{method:"post",data:_.extend({dlajax_action:"store_media_file",dlajax_subaction:"sync_media_ids",data_file:JSON.stringify({post:{action:response.data.action,ID:response.data.postID}})},dlform.getFormHiddenFields()),success:function(success){_self.toggleLoader();_self.showAlert(response.message,"success",["la","la-check"])}})}else{var eventDetail={dropzoneCb:[{name:"sending",cb:function(file,xhr,formData){var fields=_.extend({dlajax_action:"store_media_file",data_file:JSON.stringify({post:{action:response.data.action,ID:response.data.postID}})},dlform.getFormHiddenFields());_.forEach(fields,function(value,key){formData.append(key,value)})}}]};if("edit"!==response.data.action){eventDetail.dropzoneCb.push({name:"queuecomplete",cb:function(){$.ajax(dllocalized.site_url+"/index.php",{method:"post",data:_.extend({dlajax_action:"post_listing_form_submit_tasks",action:response.data.action,qibla_newly_post:response.data.postID},dlform.getFormHiddenFields()),success:function(success){var location=success.data.data.location;if(!_.isUndefined(location)){window.location=location}}})}})}else{eventDetail.dropzoneCb.push({name:"queuecomplete",cb:function(){_self.toggleLoader();_self.showAlert(response.message,"success",["la","la-check"])}})}this.dispatch("ajax-form-submit-files",eventDetail)}}else{switch(response.data.action){default:this.toggleLoader();this.showAlert(response.message,"success",["la","la-check"]);break}}}});dlform.init()}})})(window.dllocalized,window.jQuery,window.DL);